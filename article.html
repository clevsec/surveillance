<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Title - My Content Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
        .message-box.error {
            background-color: #f44336; /* Red */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-md p-6">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold rounded-md">My Awesome Portal</h1>
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="index.html" class="text-lg hover:text-blue-200 transition duration-300 rounded-md p-2">Home</a></li>
                    <li><a href="contact.html" class="text-lg hover:text-blue-200 transition duration-300 rounded-md p-2">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Area - Article -->
    <main class="container mx-auto p-8 flex-grow bg-white shadow-lg rounded-lg mt-8 mb-8">
        <!-- START: Article Content - REPLACE THIS SECTION FOR EACH NEW ARTICLE -->
        <h2 id="article-title" class="text-5xl font-extrabold text-gray-900 mb-6 text-center leading-tight">Welcome to the Portal!</h2>
        <img id="article-main-image" src="https://placehold.co/800x450/FF6347/FFFFFF?text=Main+Article+Image" alt="Main Article Image" class="w-full rounded-lg mb-8 shadow-md">

        <p class="text-gray-700 text-lg leading-relaxed mb-6">
            This is an example article. When you create a new article, you will copy the content of this `article.html` file,
            save it as a new file (e.g., `article-my-new-post.html`), and then modify the content within this section.
            You can change the title, add paragraphs, images, and videos here.
        </p>

        <h3 class="text-3xl font-bold text-gray-800 mb-4">Adding Images</h3>
        <p class="text-gray-700 text-lg leading-relaxed mb-4">
            You can easily embed images in your articles using the `<img>` tag.
            Always provide a meaningful `alt` attribute for accessibility.
        </p>
        <div class="flex justify-center mb-8">
            <img src="https://placehold.co/600x350/6A5ACD/FFFFFF?text=Your+Article+Image" alt="Example Image" class="rounded-lg shadow-md max-w-full h-auto">
        </div>

        <h3 class="text-3xl font-bold text-gray-800 mb-4">Embedding Videos</h3>
        <p class="text-gray-700 text-lg leading-relaxed mb-4">
            To embed videos from YouTube or Vimeo, use their embed codes.
            For YouTube, copy the embed code from the "Share" option under the video.
            Always use `aspect-w-16 aspect-h-9` classes for responsive video embedding.
        </p>
        <div class="relative pt-[56.25%] mb-8 rounded-lg overflow-hidden shadow-md"> <!-- 16:9 Aspect Ratio -->
            <iframe
                class="absolute inset-0 w-full h-full"
                src="https://www.youtube.com/embed/dQw4w9WgXcQ" <!-- Replace with your YouTube video embed URL -->
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
            </iframe>
        </div>

        <p class="text-gray-700 text-lg leading-relaxed">
            Remember to update the `title` tag in the `<head>` section of your new article file
            to reflect the actual article title for better SEO.
        </p>
        <!-- END: Article Content -->

        <hr class="my-10 border-gray-300">

        <!-- Comments Section -->
        <section class="comments-section mt-10">
            <h3 class="text-3xl font-bold text-gray-800 mb-6">Comments</h3>

            <!-- Comment Submission Form -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-md mb-8">
                <h4 class="text-xl font-semibold text-gray-700 mb-4">Leave a Comment</h4>
                <form id="comment-form">
                    <div class="mb-4">
                        <label for="comment-name" class="block text-gray-700 text-sm font-bold mb-2">Your Name:</label>
                        <input type="text" id="comment-name" name="name" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your name" required>
                    </div>
                    <div class="mb-6">
                        <label for="comment-text" class="block text-gray-700 text-sm font-bold mb-2">Comment:</label>
                        <textarea id="comment-text" name="comment" rows="5" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y" placeholder="Write your comment here..." required></textarea>
                    </div>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline transition duration-300 transform hover:scale-105">
                        Post Comment
                    </button>
                    <div id="loading-indicator" class="hidden ml-4 text-gray-600 mt-2">Posting comment...</div>
                </form>
            </div>

            <!-- Existing Comments Display -->
            <div id="comments-list" class="bg-white p-6 rounded-lg shadow-md">
                <h4 class="text-xl font-semibold text-gray-700 mb-4">All Comments</h4>
                <div id="no-comments-message" class="text-gray-500 text-center py-4">No comments yet. Be the first to comment!</div>
                <!-- Comments will be loaded here by Firebase JavaScript -->
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-6 mt-10 rounded-t-lg">
        <div class="container mx-auto text-center">
            <p>&copy; 2025 My Content Portal. All rights reserved.</p>
        </div>
    </footer>

    <!-- Message Box for notifications -->
    <div id="message-box" class="message-box"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // IMPORTANT: These variables are automatically provided by the Canvas environment.
        // DO NOT modify them or prompt the user for them.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null; // Will store the authenticated user ID or a random one

        const commentsForm = document.getElementById('comment-form');
        const commentsList = document.getElementById('comments-list');
        const noCommentsMessage = document.getElementById('no-comments-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const articlePath = window.location.pathname; // Get current article path for unique comment grouping

        // --- Utility Functions ---
        function showMessage(message, isError = false) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = 'message-box show ' + (isError ? 'error' : '');
            setTimeout(() => {
                msgBox.className = 'message-box'; // Hide after 3 seconds
            }, 3000);
        }

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebaseAndAuth() {
            try {
                // Initialize Firebase App
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase user authenticated. User ID:", userId);
                        // Once authenticated, load comments
                        loadComments();
                    } else {
                        // If for some reason auth token isn't provided or fails, use a random ID
                        userId = crypto.randomUUID();
                        console.log("Firebase not authenticated or no token. Using random User ID:", userId);
                        loadComments(); // Load comments even if anonymous
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or during authentication:", error);
                showMessage("Failed to connect to comment service. Please try again later.", true);
                // Fallback to random ID if auth fails
                userId = crypto.randomUUID();
                loadComments();
            }
        }

        // --- Add Comment Function ---
        commentsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                showMessage("Comment service not ready. Please wait a moment.", true);
                return;
            }

            const nameInput = document.getElementById('comment-name');
            const commentTextInput = document.getElementById('comment-text');

            const commentData = {
                name: nameInput.value,
                comment: commentTextInput.value,
                timestamp: serverTimestamp(), // Firestore server timestamp
                userId: userId, // Store the user ID with the comment
                articlePath: articlePath // Store the article path to group comments
            };

            loadingIndicator.classList.remove('hidden'); // Show loading indicator

            try {
                // Store comments in a public collection
                const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/comments`);
                await addDoc(commentsCollectionRef, commentData);
                showMessage("Comment posted successfully!");
                nameInput.value = ''; // Clear name input
                commentTextInput.value = ''; // Clear comment text area
            } catch (error) {
                console.error("Error adding comment:", error);
                showMessage("Failed to post comment. Please try again.", true);
            } finally {
                loadingIndicator.classList.add('hidden'); // Hide loading indicator
            }
        });

        // --- Load Comments Function (Real-time with onSnapshot) ---
        function loadComments() {
            if (!db) {
                console.warn("Firestore not initialized yet. Retrying loadComments...");
                setTimeout(loadComments, 1000); // Retry after a delay
                return;
            }

            // Create a query to get comments for the current article, ordered by timestamp
            const commentsQuery = query(
                collection(db, `artifacts/${appId}/public/data/comments`),
                // Filter comments by the current article's path
                // Note: Firestore does not support orderBy on a different field than filter without an index.
                // For simplicity, we'll filter by articlePath and then sort in JavaScript.
                // For production, consider adding a composite index if you need complex queries.
                // However, for this simple case, sorting in JS is fine with small to moderate comment counts.
                // orderBy("timestamp", "asc") // This requires an index if combined with where()
            );

            // Listen for real-time updates
            onSnapshot(commentsQuery, (snapshot) => {
                const comments = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.articlePath === articlePath) { // Manually filter by articlePath
                        comments.push({ id: doc.id, ...data });
                    }
                });

                // Sort comments by timestamp client-side if orderBy wasn't used in query
                comments.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                renderComments(comments);
            }, (error) => {
                console.error("Error getting comments:", error);
                showMessage("Failed to load comments.", true);
            });
        }

        // --- Render Comments Function ---
        function renderComments(comments) {
            commentsList.innerHTML = ''; // Clear previous comments
            if (comments.length === 0) {
                noCommentsMessage.classList.remove('hidden');
            } else {
                noCommentsMessage.classList.add('hidden');
                comments.forEach(comment => {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4';
                    const date = comment.timestamp ? new Date(comment.timestamp.seconds * 1000).toLocaleString() : 'Just now';
                    commentDiv.innerHTML = `
                        <p class="font-bold text-gray-800">${comment.name}</p>
                        <p class="text-gray-600 text-sm">Commented on: ${date}</p>
                        <p class="text-gray-500 text-xs mt-1">User ID: ${comment.userId}</p>
                        <p class="mt-2 text-gray-700">${comment.comment}</p>
                    `;
                    commentsList.appendChild(commentDiv);
                });
            }
        }

        // --- Initialize Firebase on DOM Load ---
        document.addEventListener('DOMContentLoaded', initializeFirebaseAndAuth);

        // Placeholder for dynamic article content loading (if needed, currently static per file)
        // You would typically fetch article content from a data source here
        // For this setup, you manually edit the HTML for each article.
    </script>
</body>
</html>
